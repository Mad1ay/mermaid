# UC-FR6.1.5: Управління депозитним рахунком клієнта

## Загальна інформація

- **ID:** UC-FR6.1.5
- **Назва:** Управління депозитним рахунком клієнта
- **Актори:** Внутрішній адміністратор, Адміністратор рецепції
- **Тип:** Use Case

## Опис

Поповнення депозитного рахунку клієнта та використання цих коштів для оплати послуг і товарів. Система підтримує як фіскальне, так і нефіскальне поповнення, а також гнучке використання депозиту з урахуванням незворотного залишку.

## Передумови

- Актор авторизований у системі
- Клієнта ідентифіковано в системі
- Депозитний рахунок створено для клієнта
- Інтеграція з РРО налаштована (для фіскального поповнення)

## Основні сценарії

### Сценарій 1: Поповнення депозиту

**Послідовність дій:**

#### 1. Ініціація поповнення

1. Актор знаходить клієнта в системі (через пошук або сканування картки)
2. Відкриває профіль клієнта
3. Обирає опцію "Поповнити депозит"
4. Система відображає поточний баланс депозиту

#### 2. Визначення параметрів поповнення

1. Актор вводить суму поповнення
2. Обирає тип поповнення:
   - **Фіскальне** - з друком фіскального чека через РРО
   - **Нефіскальне** - без фіскалізації (для внутрішніх операцій)

#### 3. Прийняття оплати

**Варіант А: Готівка**
1. Актор обирає спосіб оплати "Готівка"
2. Приймає готівку від клієнта
3. Підтверджує отримання суми в системі

**Варіант Б: Банківська картка**
1. Актор обирає спосіб оплати "Картка"
2. Система передає суму на банківський термінал
3. Клієнт здійснює оплату картою
4. Термінал підтверджує успішну транзакцію
5. Система отримує підтвердження

#### 4. Оновлення балансу та друк чека

1. Система додає суму до балансу депозитного рахунку клієнта
2. Фіксує транзакцію з деталями:
   - Дата та час
   - Сума поповнення
   - Спосіб оплати
   - Тип операції (фіскальна/нефіскальна)
   - Співробітник, що провів операцію

3. **Якщо поповнення фіскальне:**
   - Система автоматично надсилає дані на РРО
   - РРО друкує фіскальний чек
   - Актор передає чек клієнту

4. **Якщо поповнення нефіскальне:**
   - Система друкує нефіскальний чек-підтвердження
   - Актор передає чек клієнту

5. Система відображає оновлений баланс депозиту

**Післяумови:**
- Баланс депозитного рахунку збільшено на суму поповнення
- Транзакція зафіксована в історії операцій
- Клієнт отримав чек (фіскальний або нефіскальний)

### Сценарій 2: Використання депозиту для оплати

**Послідовність дій:**

#### 1. Ініціація оплати депозитом

1. Під час формування замовлення клієнт бажає оплатити депозитом
2. Актор обирає метод оплати "Депозит" в системі
3. Система відображає поточний баланс депозитного рахунку клієнта

#### 2. Визначення суми до списання

1. Актор вводить суму, яку потрібно списати з депозиту
2. Може обрати:
   - Конкретну суму
   - "Списати весь доступний баланс"
   - "Оплатити максимально можливу суму"

#### 3. Перевірка балансу та обмежень

**Система виконує перевірки:**

1. **Перевірка достатності коштів:**
   - Порівнює введену суму з поточним балансом
   - Враховує незворотний залишок (якщо налаштовано)

2. **Незворотний залишок:**
   - Якщо налаштовано мінімальний незворотний залишок (наприклад, 50 грн)
   - Система не дозволяє списати кошти нижче цього порогу
   - Доступна сума = Баланс - Незворотний залишок

3. **Результати перевірки:**

**Варіант А: Коштів достатньо**
- Система дозволяє списати повну введену суму
- Переходить до списання

**Варіант Б: Коштів недостатньо**
- Система визначає максимально доступну суму
- Пропонує списати всю доступну суму
- Інформує, що залишок необхідно оплатити іншим методом

**Варіант В: Порушення незворотного залишку**
- Система коригує суму до списання
- Залишає на рахунку незворотний залишок
- Інформує актора про автоматичне коригування

#### 4. Списання коштів

1. Система списує затверджену суму з депозитного рахунку
2. Зменшує баланс депозиту
3. Фіксує транзакцію з деталями:
   - Дата та час
   - Сума списання
   - Номер замовлення/чеку
   - Співробітник

#### 5. Коригування суми до оплати

1. Система зменшує загальну суму замовлення на списану суму з депозиту
2. Відображає оновлену суму до оплати

#### 6. Доплата іншим методом (якщо необхідно)

**Якщо депозиту було недостатньо:**
1. Система показує залишок до оплати
2. Актор пропонує клієнту обрати інший метод оплати:
   - Готівка
   - Банківська картка
   - Бонуси (якщо доступно)
3. Обробляє доплату обраним методом

**Післяумови:**
- Баланс депозитного рахунку зменшено на списану суму
- Сума замовлення до оплати зменшена або повністю оплачена
- Транзакція списання зафіксована
- Незворотний залишок збережено (якщо налаштовано)

## Альтернативні потоки

### Недостатньо коштів на депозиті

**Сценарій:**
- Клієнт бажає оплатити 500 грн депозитом
- На балансі лише 300 грн
- Незворотний залишок = 0 грн

**Дії системи:**
1. Інформує, що доступно лише 300 грн
2. Пропонує списати 300 грн з депозиту
3. Актор підтверджує часткове списання
4. Система списує 300 грн
5. Залишок 200 грн потрібно оплатити іншим методом
6. Актор обирає спосіб оплати для 200 грн
7. Завершує оплату

### Незворотний залишок активний

**Сценарій:**
- Баланс депозиту = 150 грн
- Незворотний залишок = 50 грн
- Клієнт бажає оплатити 120 грн

**Дії системи:**
1. Розраховує доступну суму: 150 - 50 = 100 грн
2. Інформує, що можна списати максимум 100 грн
3. Автоматично коригує суму до 100 грн
4. Списує 100 грн
5. Залишок на депозиті = 50 грн (незворотний)
6. Залишок до оплати = 20 грн оплачується іншим методом

### Помилка РРО при фіскальному поповненні

**Сценарій:**
- Клієнт поповнює депозит фіскально на 1000 грн
- Оплата пройшла успішно
- РРО не відповідає або повертає помилку

**Дії системи:**
1. Система фіксує помилку РРО
2. **Не додає** кошти на депозит автоматично
3. Інформує актора про проблему
4. Пропонує варіанти:
   - Спробувати повторно
   - Оформити нефіскальне поповнення
   - Скасувати операцію та повернути кошти

5. Актор обирає дію відповідно до ситуації

## Виняткові ситуації

### Збій системи під час поповнення

- Оплата отримана, але система не відреагувала
- Використовується журнал транзакцій
- Адміністратор вручну перевіряє та додає кошти на рахунок

### Негативний баланс (технічна помилка)

- Система не повинна дозволяти негативний баланс
- Якщо виникла помилка - блокування подальших списань
- Адміністратор коригує баланс вручну

### Спроба списання при нульовому балансі

- Система блокує операцію
- Інформує, що депозит порожній
- Пропонує поповнити або обрати інший метод оплати

## Бізнес-правила

### Мінімальна сума поповнення

- Може бути встановлено мінімальну суму поповнення (наприклад, 50 грн)
- Система перевіряє при введенні суми

### Незворотний залишок

- Налаштовується в системі (наприклад, 50 грн або 0 грн)
- Завжди залишається на рахунку, не може бути витрачений
- Забезпечує мінімальну активність рахунку

### Фіскалізація

- Фіскальне поповнення обов'язково супроводжується фіскальним чеком
- Нефіскальне - для внутрішніх операцій, компенсацій
- Вибір типу визначається політикою компанії та податковим законодавством

### Терміни дії депозиту

- Депозит може бути безстроковим
- Або з терміном дії (наприклад, сертифікати на рік)
- Система контролює терміни та блокує прострочені депозити

## Пов'язані Use Cases

- UC-FR6.1.1: Управління профілем клієнта
- UC-FR6.3.3: Обробка оплати замовлення
- UC-FR6.3.5: Друк фіскальних чеків
- UC-FR6.5.5: Облік дебіторської заборгованості

## Інтеграції

- **РРО (Реєстратор розрахункових операцій):** Фіскалізація поповнень
- **Банківський термінал:** Прийняття платежів картами
- **Система обліку:** Фіксація фінансових операцій
- **1С:** Синхронізація балансів та транзакцій

## Звітність

### Звіти по депозитним рахункам

- Загальна сума коштів на депозитах (по всіх клієнтах)
- Історія операцій з депозитом конкретного клієнта
- Звіт про поповнення за період
- Звіт про використання депозитів за період
- Клієнти з найбільшими балансами депозитів

## Метрики успішності

- Середній час поповнення депозиту (цільовий: < 1 хвилини)
- Відсоток успішних транзакцій поповнення (цільовий: > 99%)
- Середній баланс депозитного рахунку на одного клієнта
- Частота використання депозитів для оплати
- Загальна сума коштів на депозитах (ліквідність)

## Переваги для бізнесу

1. **Попередня оплата:** Гарантовані кошти від клієнтів
2. **Зручність для клієнтів:** Швидка оплата без готівки/картки
3. **Лояльність:** Стимулювання повторних відвідувань
4. **Ліквідність:** Покращення cash flow
5. **Аналітика:** Розуміння споживчої поведінки
